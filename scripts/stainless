#!/bin/bash

set -e

# Parse command line arguments
DEV_MODE=false
for arg in "$@"; do
    if [ "$arg" = "--dev" ]; then
        DEV_MODE=true
    fi
done

bun run ./packages/opencode/src/index.ts generate > openapi.json

echo "Running stl builds create..."
stl builds create --branch dev --pull --allow-empty --+target go --+target typescript

echo "Cleaning up..."
rm -rf packages/sdk
mkdir -p packages/sdk

mv opencode-go/ packages/sdk/go
rm -rf packages/sdk/go/.git
rm -rf packages/sdk/go/go.mod
rm -rf packages/sdk/go/go.sum

mv opencode-typescript/ packages/sdk/js
rm -rf packages/sdk/js/.git
rm -rf packages/sdk/js/yarn.lock

# Only run production build if not in dev mode
if [ "$DEV_MODE" = false ]; then
    echo "Kicking off production build..."
    stl builds create --branch main --wait=false
else
    echo "Skipping production build (--dev flag detected)"
fi

echo "Done!"

